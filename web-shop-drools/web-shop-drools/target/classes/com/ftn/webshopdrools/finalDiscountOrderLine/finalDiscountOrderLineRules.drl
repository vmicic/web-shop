//created on: May 16, 2020
package com.ftn.webshopdrools.finalDiscountOrderLine;

//list any import classes here.

import com.ftn.webshop.domain.DiscountForItem;
import com.ftn.webshop.domain.Order;
import com.ftn.webshop.domain.OrderLine;
import com.ftn.webshop.domain.Item;
import com.ftn.webshop.domain.ItemCategory;
import com.ftn.webshop.domain.TypeOfDiscount;
import com.ftn.webshop.domain.User;
import com.ftn.webshop.domain.Promotion;

global com.ftn.webshop.services.impl.OrderLineServiceImpl orderLineService;



rule "Calculate total discount"
	salience 400
    when
    	$o: Order($lines: orderLines)
    	$orderLine: OrderLine($discounts: discountsForItem, $category: item.category, $priceTotal: priceTotal, percentageDiscount == null) from $lines
    	Number($sumOfDiscounts: doubleValue) from accumulate(
    		DiscountForItem(
    			$dp: discountPercentage
    		) from $discounts,
    		sum($dp)
    	)
    then
    	 System.out.println("Sum of discounts: " + $sumOfDiscounts + ", item category: " + $category + ", price total is: " + $priceTotal	);               
    	 modify($orderLine) {
    	 	//iz nekog razloga mi ne da dve set naredbe u modify pa sam namestanje prica sa discountom implementirao u klasi
        	setPercentageDiscount($sumOfDiscounts);
        }     
    	orderLineService.save($orderLine);

end

rule "Check discount if too big"
	salience 300
    when
    	$o: Order($lines: orderLines)
    	$orderLine: OrderLine($percentageDiscount: percentageDiscount > $maxDiscount: item.category.maxPercentageDiscount) from $lines
    then
    	System.out.println("Discount: " + $percentageDiscount + ", bigger than allowed: " + $maxDiscount);    	 
    	modify($orderLine) {
        	setPercentageDiscount($maxDiscount);
        }     
    	orderLineService.save($orderLine);
end











